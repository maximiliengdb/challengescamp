{% extends "CC/base.html" %}
{% block content %}
{% load staticfiles %}

{% include "CC/naviguation.html" %}

        <div class="content">
            <div class="container-fluid">

            {% if message != 'False' %}
                <div class="alert {{type_message}}">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">×</button>
                    <span>{{message}}</span>
                </div>
            {% endif %}

                <div class="card">
                    <div class="header">
                        <h4 class="title">MAP</h4><div id="demo"></div>
                    </div>
                    <div class="content">
                        
                        <div id='map' style='width: auto; height: 500px;'></div>
                    <div class="footer">
                        <hr>
                        <div class="stats">
                            <i class="ti-reload"></i> Mise à jour : <script>document.write(new Date())</script>
                        </div>
                    </div>
                    </div>
                </div>
             </div>
        </div>


{% block javascript %}
<script>

    var options = {
    enableHighAccuracy: true,
    timeout: 2000,
    maximumAge: 0
    };

   

    function success(pos) {
    var crd = pos.coords;

    console.log('Your current position is:');
    console.log(`Latitude : ${crd.latitude}`);
    console.log(`Longitude: ${crd.longitude}`);
    console.log(`More or less ${crd.accuracy} meters.`);
    
    
      
    
    var map = new mapboxgl.Map({
    container: 'map',
    style: 'https://raw.githubusercontent.com/osm2vectortiles/mapbox-gl-styles/master/styles/bright-v9-cdn.json',
    center: [crd.longitude, crd.latitude],
    zoom: 14,
    });

    map.addControl(new mapboxgl.NavigationControl());
    

    map.on('load', function () {
      
    {% for user in users %}
    map.loadImage('{{user.pp.image.url}}', function(error, image) {
        if (error) throw error;
        map.addImage('{{user.username}}', image);
        
        {{user.username}} = '/user_position/?id_user={{user.id}}';

        window.setInterval(function() {

            map.getSource('{{user.id}}').setData({{user.username}});

        }, 8000);

        map.addSource('{{user.id}}', { type: 'geojson', data: {{user.username}} });
        map.addLayer({
                        "id": "{{user.id}}",
                        "type": "symbol",
                        "source": '{{user.id}}',
                        "layout": {
                            "icon-image": "{{user.username}}",
                            "icon-size": 0.15,
                            "icon-allow-overlap": true
                        }
                    });

                    // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', '{{user.id}}', function (e) {
                        new mapboxgl.Popup()
                            .setLngLat(e.features[0].geometry.coordinates)
                            .setHTML(e.features[0].properties.description)
                            .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', '{{user.id}}', function () {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', '{{user.id}}', function () {
                        map.getCanvas().style.cursor = '';
                    });
                });

    {% endfor %}
    
        map.loadImage('{{utilisateur.pp.image.url}}', function(error, image) {
        
        if (error) throw error;
        map.addImage('utilisateur', image);

        utilisateur_position = '/user_position_me/?id_user={{utilisateur.id}}';

        window.setInterval(function() {

            $.ajax({url: '/compte/map/position/?id_user={{utilisateur.id}}&latitude='+crd.latitude+'&longitude='+crd.longitude,
            });
            map.getSource('test').setData(utilisateur_position);

        }, 1000);



        map.addSource('test', { type: 'geojson', data: utilisateur_position });
        map.addLayer({
                        "id": "{{utilisateur.id}}",
                        "type": "symbol",
                        "source": "test" ,
                        "layout": {
                            "icon-image": "utilisateur",
                            "icon-size": 0.2,
                            "icon-allow-overlap": true
                        }
                    });

                    // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', '{{user.id}}', function (e) {
                        new mapboxgl.Popup()
                            .setLngLat(e.features[0].geometry.coordinates)
                            .setHTML(e.features[0].properties.description)
                            .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', '{{user.id}}', function () {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', '{{user.id}}', function () {
                        map.getCanvas().style.cursor = '';
                    });
                });  

       

        }); 
    };

    function error(err) {
    document.location.href="/compte/map_error";
    console.warn(`ERROR(${err.code}): ${err.message}`);
    };

    navigator.geolocation.getCurrentPosition(success, error, options);
    

    $('.nbre_notification').click(function () {
            $.ajax({
            url: '/compte/vue_notification/',
            });
            $("#notifications").load("/compte/vestiaire/ #notifications");
            $("#notificationspetit").load("/compte/vestiaire/ #notificationspetit");
        });
        
        $('div.block_notification').click(function () {
            var id = $(this).attr('value');
            $.ajax({
            url: '/compte/active_notification/?notif_id='+id
            });
        });
</script>
{% endblock %}

{% endblock %}